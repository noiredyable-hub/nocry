// ==UserScript==
// @name         QX NILOY V1.8.9 - DECODED & DOCUMENTED
// @version      7.8.15-nopass-DECODED
// @description  ØªÙ„Ø§Ø¹Ø¨ Ø¨Ù…Ù†ØµØ© Quotex + Ù†Ø¸Ø§Ù… ØªØ±Ø®ÙŠØµ Firebase (Ù…ÙÙƒÙƒ ÙˆÙ…ÙˆØ«Ù‚)
// @author       QX + Copilot Update | ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±: AI Assistant
// @match        *://market-qx.trade/*
// @grant        none
// ==/UserScript==

(function () {
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: ØªÙ„Ø§Ø¹Ø¨ Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (Trading Platform Spoofer)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ Ø®Ø¯Ø¹Ø© URL: Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Trade Ø¥Ù„Ù‰ Demo-Trade Ù…Ø¹ ØªØ²ÙˆÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† â”€â”€â”€
if (location.href === "https://market-qx.trade/en/trade") {
    location.replace("https://market-qx.trade/en/demo-trade");
    return;
}

if (location.href === "https://market-qx.trade/en/demo-trade") {
    const fakeUrl = "https://market-qx.trade/en/trade";
    const fakeTitle = "Live trading | Quotex";
    
    document.title = fakeTitle;
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ²ÙˆÙŠØ±
    new MutationObserver(() => {
        if (document.title !== fakeTitle) document.title = fakeTitle;
    }).observe(document.querySelector('title'), { childList: true });
    
    history.replaceState(null, "", fakeUrl);
}

// â”€â”€â”€ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø´ÙØ±Ø© Ø¨Ù€ Base64 â”€â”€â”€
const now = Date.now();
const pwKey = atob("c2x0ZWNoX3ZlcmlmaWVkX2luZm8=");      // "sltech_verified_info"
const balKey = atob("aW5pdGlhbEJhbGFuY2VJbmZv");          // "initialBalanceInfo"
const lbKey = atob("c2x0ZWNoX2xlYWRlcmJvYXJkX2RhdGE=");  // "sltech_leaderboard_data"
const demoBalKey = "sltechbd_demo_balance";

// â”€â”€â”€ Ù…Ø­Ø¯Ø¯Ø§Øª CSS Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© â”€â”€â”€
const selectors = {
    positionHeaderMoney: ".position__header-money.--green, .position__header-money.--red",
    usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
    usermenuIconUse: ".---react-features-Usermenu-styles-module__infoLevels--ePf8T svg use",
    usermenuName: ".---react-features-Usermenu-styles-module__infoName--SfrTV.---react-features-Usermenu-styles-module__demo--TmWTp",
    levelName: ".---react-features-Usermenu-Dropdown-styles-module__levelName--wFviC",
    levelProfit: ".---react-features-Usermenu-Dropdown-styles-module__levelProfit--UkDJi",
    levelIcon: ".---react-features-Usermenu-Dropdown-styles-module__levelIcon--lmj_k svg use",
    usermenuListItems: "li",
    liveBalanceText: ".---react-features-Usermenu-styles-module__infoText--58LeE .---react-features-Usermenu-styles-module__infoBalance--pVBHU"
};

const activeClass = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const numFromText = s => s ? parseFloat(s.replace(/[^0-9.]/g, "")) : NaN;

// â”€â”€â”€ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ â”€â”€â”€
function formatWithThousands(num) {
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatProfitDisplay(diff) {
    const val = formatWithThousands(Math.abs(diff));
    return diff < 0 ? `-$${val}` : `$${val}`;
}

function formatAmount(num) { 
    return "$" + num.toFixed(2); 
}

// â”€â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© â”€â”€â”€
let initialBal = 0;
const savedBal = localStorage.getItem(balKey);
if (savedBal) {
    const d = JSON.parse(savedBal);
    if (now - d.timestamp < 864e5) initialBal = parseFloat(d.balance);
}

let demoBalance = 10000;
const savedDemoBal = localStorage.getItem(demoBalKey);
if (savedDemoBal) {
    const d = JSON.parse(savedDemoBal);
    if (now - d.timestamp < 864e5) demoBalance = parseFloat(d.balance);
}

// â”€â”€â”€ ØªØ²ÙˆÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø¥Ø¸Ù‡Ø§Ø± Live Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Demo) â”€â”€â”€
function spoofUI() {
    const listItems = $$(selectors.usermenuListItems);
    if (!listItems.length) return;
    
    const demoLi = listItems.find(li => li.innerText.includes("Demo Account"));
    const liveLi = listItems.find(li => li.innerText.includes("Live"));
    if (!demoLi || !liveLi) return;
    
    const demoBalanceElem = demoLi.querySelector("b");
    const liveBalanceElem = liveLi.querySelector("b");
    if (!demoBalanceElem || !liveBalanceElem) return;

    const fixedDemoAmountStr = formatAmount(demoBalance);
    const liveBalanceFromUI = $(selectors.liveBalanceText);
    let liveBalanceValue = 0;
    if (liveBalanceFromUI) {
        liveBalanceValue = numFromText(liveBalanceFromUI.textContent);
        if (isNaN(liveBalanceValue)) liveBalanceValue = 0;
    }
    const liveAmountStr = formatAmount(liveBalanceValue);

    demoBalanceElem.textContent = fixedDemoAmountStr;
    liveBalanceElem.textContent = liveAmountStr;
    
    if (demoLi.classList.contains(activeClass)) demoLi.classList.remove(activeClass);
    if (!liveLi.classList.contains(activeClass)) liveLi.classList.add(activeClass);
}

// â”€â”€â”€ Ù†Ø¸Ø§Ù… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ â”€â”€â”€
let lastProfitDiff = null;
let currentExpandPercent = parseInt(localStorage.getItem('expandPercent')) || 0;

function updatePositionExpandOnProfitChange(forceFullBar = false) {
    const bal = numFromText($(selectors.usermenuBalance)?.textContent);
    if (isNaN(bal)) return;
    
    const diff = bal - initialBal;
    
    if (diff !== lastProfitDiff) {
        currentExpandPercent = Math.floor(Math.random() * 91) + 10;
        lastProfitDiff = diff;
        localStorage.setItem('expandPercent', currentExpandPercent);

        const expandSpan = document.querySelector(".position__loading .position__expand");
        if (expandSpan) expandSpan.style.width = forceFullBar ? '100%' : (currentExpandPercent + "%");

        const slider = document.getElementById('capitalPercentSlider');
        if (slider) {
            slider.value = currentExpandPercent;
            updatePercentDisplay(currentExpandPercent);
        }
    } else {
        const expandSpan = document.querySelector(".position__loading .position__expand");
        if (expandSpan) expandSpan.style.width = forceFullBar ? '100%' : (currentExpandPercent + "%");
    }
}

function updatePercentDisplay(value) {
    const display = document.getElementById("sliderPercentDisplay");
    if (display) display.textContent = value + "%";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ø¸Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Leaderboard Injection)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const leaderboardSelector = '.leader-board__items';
const leaderboardRowSelector = '.leader-board__item';
const yourHeaderSelector = '.position__header';
const yourFooterSelector = '.position__footer';

let currentRowIndex = null;
const originalRows = {};

// Ù†Ù‚Ø§Ø· Ø§Ù„ØªØµÙ†ÙŠÙ: Ø±Ø¨Ø­ â†â†’ ØªØ±ØªÙŠØ¨
const points = [
    { profit: -10000, position: 60000 },
    { profit: 0, position: 58471 },
    { profit: 1, position: 3154 },
    { profit: 7886, position: 21 },
    { profit: 20000, position: 1 }
];

function parseMoney(text) {
    return parseFloat(text.replace(/[^0-9.-]+/g, '')) || 0;
}

function getYourData() {
    const header = document.querySelector(yourHeaderSelector);
    if (!header) return null;

    const nameEl = header.querySelector('.position__header-name');
    const name = nameEl?.textContent.trim() ?? '';

    const moneyEl = header.querySelector('.position__header-money');
    const profitText = moneyEl?.textContent.trim() ?? '';
    const profit = parseMoney(profitText);

    if (!moneyEl) {
        return { name, profit: 0, profitText: profitText || '$0.00', flagCode: 'ca' };
    }

    const flagSvg = nameEl.querySelector('svg');
    const flagClass = flagSvg?.getAttribute('class') || '';
    const flagUse = flagSvg?.querySelector('use')?.getAttribute('xlink:href') || '';
    const flagCode = flagClass.replace('flag-', '') || flagUse.split('#')[1];

    return { name, profit, profitText, flagCode };
}

function updateFooter(positionNum) {
    const footer = document.querySelector(yourFooterSelector);
    if (footer) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${positionNum}`;
    }
}

function restoreOldRow(index) {
    const row = document.querySelectorAll(leaderboardRowSelector)[index];
    if (row && originalRows[index]) {
        row.innerHTML = originalRows[index];
    }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø®Ø·ÙŠ
function calculateInterpolatedPosition(profit) {
    const sortedPoints = points.slice().sort((a, b) => a.profit - b.profit);

    if (profit <= sortedPoints[0].profit) {
        const p0 = sortedPoints[0];
        const p1 = sortedPoints[1];
        const m = (p1.position - p0.position) / (p1.profit - p0.profit);
        const pos = m * (profit - p0.profit) + p0.position;
        return Math.max(1, Math.round(pos));
    }

    if (profit >= sortedPoints[sortedPoints.length - 1].profit) {
        return sortedPoints[sortedPoints.length - 1].position;
    }

    for (let i = 0; i < sortedPoints.length - 1; i++) {
        const p1 = sortedPoints[i];
        const p2 = sortedPoints[i + 1];
        if (profit >= p1.profit && profit <= p2.profit) {
            const m = (p2.position - p1.position) / (p2.profit - p1.profit);
            const pos = m * (profit - p1.profit) + p1.position;
            return Math.max(1, Math.round(pos));
        }
    }
    return Math.max(1, sortedPoints[0].position);
}

function updateLinearPosition(profit) {
    const footer = document.querySelector(yourFooterSelector);
    if (!footer) return;
    
    const position = calculateInterpolatedPosition(profit);
    const currentText = footer.innerText.replace(/\D/g, '');
    const newText = position.toString();
    
    if (currentText !== newText) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${newText}`;
        localStorage.setItem('lastPositionNumber', newText);
    }
}

function applySavedPosition() {
    const saved = localStorage.getItem('lastPositionNumber');
    const footer = document.querySelector(yourFooterSelector);
    if (saved && footer) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${saved}`;
    }
}

let lastTopPosition = null;

// Ø­Ù‚Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
function updateLeaderboard(user) {
    const leaderboard = document.querySelector(leaderboardSelector);
    if (!leaderboard) return;
    
    const rows = Array.from(leaderboard.querySelectorAll(leaderboardRowSelector));
    if (!rows.length) return;

    const yourIndex = rows.findIndex(row => {
        const moneyEl = row.querySelector('.leader-board__item-money');
        return moneyEl && parseMoney(moneyEl.textContent) <= user.profit;
    });
    
    const targetIndex = yourIndex === -1 ? rows.length - 1 : yourIndex;

    if (targetIndex !== currentRowIndex) {
        if (currentRowIndex !== null) restoreOldRow(currentRowIndex);

        const targetRow = rows[targetIndex];
        if (!targetRow) return;
        
        if (!originalRows[targetIndex]) {
            originalRows[targetIndex] = targetRow.innerHTML;
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù„Ù…
        const flagSVG = targetRow.querySelector('.leader-board__item-block svg.flag');
        const flagUSE = flagSVG?.querySelector('use');
        if (flagSVG && flagUSE && user.flagCode) {
            flagSVG.setAttribute('class', `flag flag-${user.flagCode}`);
            flagUSE.setAttribute('xlink:href', `/profile/images/flags.svg#flag-${user.flagCode}`);
        }

        // Ø¥Ø¬Ø¨Ø§Ø± ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const avatarDiv = targetRow.querySelector('.leader-board__item-avatar');
        if (avatarDiv) {
            avatarDiv.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
        }

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø¨Ø­
        const nameDiv = targetRow.querySelector('.leader-board__item-name');
        if (nameDiv) nameDiv.textContent = user.name;

        const moneyDiv = targetRow.querySelector('.leader-board__item-money');
        if (moneyDiv) {
            moneyDiv.textContent = targetIndex === 0 ? "$30,000.00+" : formatProfitDisplay(user.profit);
            moneyDiv.style.color = user.profit < 0 ? "#fd4d3c" : "#0faf59";
        }

        currentRowIndex = targetIndex;
        updateFooter(targetIndex + 1);
        lastTopPosition = (targetIndex >= 0 && targetIndex <= 2) ? (targetIndex + 1) : null;
    }
}

function checkAndUpdateLeaderboard() {
    const user = getYourData();
    if (!user) {
        if (currentRowIndex !== null) {
            restoreOldRow(currentRowIndex);
            currentRowIndex = null;
        }
        updateFooter(calculateInterpolatedPosition(0));
        lastTopPosition = null;
        return;
    }

    const leaderboard = document.querySelector(leaderboardSelector);
    if (!leaderboard) return;
    
    const rows = Array.from(leaderboard.querySelectorAll(leaderboardRowSelector));
    if (rows.length < 20) return;

    const row20 = rows[19];
    const profit20 = parseMoney(row20.querySelector('.leader-board__item-money')?.textContent || '0');

    if (user.profit >= profit20) {
        updateLeaderboard(user);
    } else {
        if (currentRowIndex !== null) {
            restoreOldRow(currentRowIndex);
            currentRowIndex = null;
        }
        updateLinearPosition(user.profit);
        lastTopPosition = null;
    }
}

function isMobile() {
    return /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);
}

// â”€â”€â”€ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© â”€â”€â”€
function updateUI() {
    const bal = numFromText($(selectors.usermenuBalance)?.textContent);
    const profitEl = $(selectors.positionHeaderMoney);
    const levelIconUse = $(selectors.usermenuIconUse);
    const levelIconDropdown = $(selectors.levelIcon);

    if (!isNaN(bal) && profitEl) {
        const diff = bal - initialBal;
        profitEl.innerText = formatProfitDisplay(diff);
        profitEl.style.color = diff < 0 ? "#fd4d3c" : "#0faf59";
    }

    let levelType = 'standart';
    if (bal > 9999.99) levelType = 'vip';
    else if (bal > 4999.99) levelType = 'pro';
    
    const iconHref = `/profile/images/spritemap.svg#icon-profile-level-${levelType}`;
    if (levelIconUse) levelIconUse.setAttribute("xlink:href", iconHref);
    if (levelIconDropdown) levelIconDropdown.setAttribute("xlink:href", iconHref);

    const nameEl = $(selectors.usermenuName);
    if (nameEl) {
        nameEl.textContent = isMobile() ? "Live" : "Live Account";
        nameEl.style.color = "#0faf59";
    }

    const levelNameElem = $(selectors.levelName);
    const levelProfitElem = $(selectors.levelProfit);
    if (levelNameElem && levelProfitElem) {
        if (levelType === "vip") {
            levelNameElem.textContent = "vip:";
            levelProfitElem.textContent = "+4% profit";
        } else if (levelType === "pro") {
            levelNameElem.textContent = "pro:";
            levelProfitElem.textContent = "+2% profit";
        } else {
            levelNameElem.textContent = "standard:";
            levelProfitElem.textContent = "+0% profit";
        }
    }

    const lbData = localStorage.getItem(lbKey);
    if (lbData) {
        const { name, flag } = JSON.parse(lbData);
        const nameBox = document.querySelector(".position__header-name");
        if (nameBox && name && flag) {
            nameBox.innerHTML = `<svg class="flag-${flag}"><use xlink:href="/profile/images/flags.svg#flag-${flag}"></use></svg> ${name}`;
        }
    }

    let forceFullBar = lastTopPosition && [1,2,3].includes(lastTopPosition);
    updatePositionExpandOnProfitChange(forceFullBar);
    checkAndUpdateLeaderboard();
}

// â”€â”€â”€ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â”€â”€â”€
let timeoutId = null;
function debouncedUpdate() {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        spoofUI();
        updateUI();
    }, 50);
}

new MutationObserver(debouncedUpdate).observe(document.body, { childList: true, subtree: true });

if (document.readyState === "complete" || document.readyState === "interactive") {
    spoofUI();
    applySavedPosition();
    updateUI();
} else {
    document.addEventListener('DOMContentLoaded', () => {
        spoofUI();
        applySavedPosition();
        updateUI();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø²Ø± Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showDepositPopup() {
    if ($('#capitalBalancePopup')) return;

    const popup = document.createElement("div");
    popup.id = "capitalBalancePopup";
    popup.innerHTML = `
<div style="font-weight:bold; font-size:22px; margin-bottom:12px; color:#0faf59; text-align:center; border-radius:10px;">
    ğŸ‘‘Ø§Ù„Ù…Ø·ÙˆØ±: DEVNILOY<br>
    <a id="telegramLink" href="https://t.me/DEVNILOY" target="_blank" style="font-size:14px; color:#fd4d3c; text-decoration:underline; cursor:pointer;">BY @DEVNILOY</a>
</div>
<label style="display:block; margin-bottom:6px;">ğŸ‘¤ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†:</label>
<input type="text" id="leaderboardNameInput" class="sl-input" value="" placeholder="DEVNILOY" />
<label style="display:block; margin:12px 0 6px;">ğŸš© ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù„Ù… (Ù…Ø«Ø§Ù„: bd):</label>
<input type="text" id="leaderboardFlagInput" class="sl-input" placeholder="Ù…Ø«Ø§Ù„: bd" />
<label style="display:block; margin:12px 0 6px;">ğŸ† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø²ÙŠÙ Ù„Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†:</label>
<input type="number" id="leaderboardInput" class="sl-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" />
<label style="display:block; margin:12px 0 6px;">ğŸ’° Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:</label>
<input type="number" id="demoBalanceInput" class="sl-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯" value="${demoBalance}" min="0" />
<label style="display:block; margin:12px 0 6px;">ğŸ“Š Ù†Ø³Ø¨Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„:</label>
<div style="position: relative; width: 100%; margin-bottom: 6px;">
<input type="range" id="capitalPercentSlider" class="sl-input" min="0" max="100" step="1" value="0" style="width: 100%;" />
<div id="sliderPercentDisplay" style="position: absolute; top: -22px; right: 10px; font-weight: bold; color: #222; background: #eee; padding: 2px 8px; border-radius: 6px; user-select: none; pointer-events: none; font-family: 'Segoe UI', sans-serif; font-size: 16px; box-shadow:0 2px 10px #2222;">0%</div>
</div>
<div style="text-align:center; margin-top:22px;">
<button id="setCapitalBtn" class="sl-button" style="background:#fdc500; color:#222;">Ø­ÙØ¸</button>
<button id="cancelCapitalBtn" class="sl-button sl-cancel" style="background:#888;">Ø¥Ù„ØºØ§Ø¡</button>
</div>
`;

    Object.assign(popup.style, {
        position: "fixed", top: "50%", left: "50%", transform: "translate(-50%, -50%)",
        background: "#fff", color: "#222",
        padding: window.innerWidth < 600 ? "5vw" : "28px", borderRadius: "20px", 
        boxShadow: "0 16px 44px rgba(0,0,0,0.23)",
        zIndex: "10000", width: window.innerWidth < 600 ? "98vw" : "380px", 
        maxWidth: "99vw", fontFamily: "'Segoe UI', sans-serif"
    });

    const style = document.createElement("style");
    style.textContent = `
.sl-input { width: 100%; padding: 13px; margin-bottom: 10px; border: 1.5px solid #b6b6b6; border-radius: 12px; background: #f9f9fd; color: #222; font-size: 16px; outline: none; transition: all 0.3s; box-shadow:0 2px 10px #ececec; }
.sl-input:focus { border-color: #1976d2; box-shadow: 0 0 7px rgba(25, 118, 210, 0.4); }
.sl-button { padding: 10px 24px; margin: 0 7px; background: #0077cc; border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.3s; }
.sl-button:hover { background: #005fa3; }
.sl-button.sl-cancel { background: #888; }
.sl-button.sl-cancel:hover { background: #666; }
@media (max-width: 600px) { #capitalBalancePopup { padding: 2vw !important; width: 98vw !important; } .sl-input, .sl-button { font-size: 18px !important; } }
`;
    document.head.appendChild(style);
    document.body.appendChild(popup);

    const slider = $('#capitalPercentSlider');
    const expandSpan = document.querySelector(".position__loading .position__expand");
    
    slider.oninput = () => {
        if (expandSpan) expandSpan.style.width = slider.value + "%";
        updatePercentDisplay(slider.value);
    };

    $('#setCapitalBtn').onclick = () => {
        const lb = parseFloat($('#leaderboardInput').value);
        const name = $('#leaderboardNameInput').value.trim();
        const flag = $('#leaderboardFlagInput').value.trim().toLowerCase();
        const ub = numFromText($(selectors.usermenuBalance)?.textContent);

        if (!isNaN(lb)) {
            const diff = ub - lb;
            if (diff < 0) return alert("Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯!");
            initialBal = diff;
        } else return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");

        localStorage.setItem(balKey, JSON.stringify({ balance: initialBal, timestamp: now }));
        if (name && flag) localStorage.setItem(lbKey, JSON.stringify({ name, flag }));

        const demoVal = parseFloat($('#demoBalanceInput').value);
        if (isNaN(demoVal) || demoVal < 0) {
            alert("Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");
            return;
        }
        demoBalance = demoVal;
        localStorage.setItem(demoBalKey, JSON.stringify({ balance: demoBalance, timestamp: Date.now() }));
        
        spoofUI();
        updateUI();
        popup.remove();
    };
    
    $('#cancelCapitalBtn').onclick = () => popup.remove();
}

// â”€â”€â”€ Ø§Ø¹ØªØ±Ø§Ø¶ Ø²Ø± Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ â”€â”€â”€
function hijackDepositBtn() {
    const allBtns = document.querySelectorAll('a,button');
    allBtns.forEach(btn => {
        if (btn._qxDepositPopup) return;
        if ((btn.href && btn.href.includes("/deposit")) ||
            (btn.textContent && btn.textContent.trim().toLowerCase() === "deposit")) {
            btn._qxDepositPopup = true;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showDepositPopup();
                return false;
            }, true);
        }
    });
}

new MutationObserver(hijackDepositBtn).observe(document.body, { childList: true, subtree: true });
if (document.readyState === "complete" || document.readyState === "interactive") {
    hijackDepositBtn();
} else {
    document.addEventListener('DOMContentLoaded', hijackDepositBtn);
}

})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ (License Verification System)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // â”€â”€â”€ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù…ÙÙƒÙƒØ©) â”€â”€â”€
    

    // â”€â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª â”€â”€â”€
    const loadFontAwesome = () => {
        return new Promise((resolve) => {
            if (document.querySelector('link[href*="font-awesome"]')) { resolve(); return; }
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
            link.onload = () => resolve();
            link.onerror = () => resolve();
            document.head.appendChild(link);
        });
    };

    const loadFirebaseSDK = () => {
        return new Promise((resolve, reject) => {
            if (window.firebase && typeof window.firebase.initializeApp === 'function') { resolve(); return; }
            
            let script1Loaded = false, script2Loaded = false, timeout;
            const checkResolve = () => {
                if (script1Loaded && script2Loaded && window.firebase && window.firebase.database) {
                    clearTimeout(timeout); resolve();
                }
            };

            const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
            script1.onload = () => { script1Loaded = true; checkResolve(); };
            script1.onerror = () => { clearTimeout(timeout); reject(new Error('Firebase App failed')); };

            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
            script2.onload = () => { script2Loaded = true; checkResolve(); };
            script2.onerror = () => { clearTimeout(timeout); reject(new Error('Firebase DB failed')); };

            timeout = setTimeout(() => {
                if (!script1Loaded || !script2Loaded) reject(new Error('Firebase timeout'));
            }, 10000);

            document.head.appendChild(script1);
            document.head.appendChild(script2);
        });
    };

    // â”€â”€â”€ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª â”€â”€â”€
    const STORAGE_KEY = 'verified_license_key';
    const STORAGE_USER_KEY = 'verified_user_data';
    const STORAGE_DEVICE_ID = 'device_fingerprint';
    const STORAGE_VERIFIED_DEVICE = 'verified_device_id';

    let database = null;
    let licenseListener = null;

    const initFirebase = async () => {
        try {
            await loadFirebaseSDK();
            if (typeof firebase === 'undefined') throw new Error('Firebase not loaded');
            
            let app;
            try { app = firebase.app(); } 
            catch (e) { app = firebase.initializeApp(firebaseConfig); }
            
            database = firebase.database();
            return true;
        } catch (error) {
            console.error('Firebase init failed:', error);
            return false;
        }
    };

    // â”€â”€â”€ ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS â”€â”€â”€
    const injectStyles = () => {
        const style = document.createElement('style');
        style.textContent = `
.license-verify-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #334155; border-radius: 16px; padding: 40px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); z-index: 99999; min-width: 400px; max-width: 500px; font-family: 'Segoe UI', sans-serif; transition: all 0.3s ease; opacity: 1; }
.license-verify-panel.hiding { opacity: 0; transform: translate(-50%, -50%) scale(0.9); pointer-events: none; }
.license-verify-panel.hidden { display: none; }
.panel-header { text-align: center; margin-bottom: 30px; }
.panel-header h2 { color: #f1f5f9; margin: 0 0 10px 0; font-size: 28px; font-weight: 600; }
.panel-icon { font-size: 48px; margin-bottom: 15px; color: #6366f1; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; color: #cbd5e1; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
.form-input { width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: #f1f5f9; font-size: 16px; font-family: 'Courier New', monospace; transition: all 0.3s ease; }
.form-input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
.verify-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 10px; }
.verify-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
.verify-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.result-message { margin-top: 20px; padding: 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-align: center; display: none; }
.result-message.show { display: block; }
.result-message.success { background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981; color: #10b981; }
.result-message.error { background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; color: #ef4444; }
.telegram-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 14px 16px; margin-top: 20px; background: linear-gradient(135deg, #0088cc 0%, #0077b5 100%); border: none; border-radius: 8px; color: white; font-size: 15px; font-weight: 600; text-decoration: none; cursor: pointer; transition: all 0.3s ease; }
.telegram-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 136, 204, 0.4); }
.user-info { margin-top: 20px; padding: 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; display: none; }
.user-info.show { display: block; }
.user-info-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.2); }
.user-info-item:last-child { border-bottom: none; }
.user-info-label { color: #94a3b8; font-weight: 500; }
.user-info-value { color: #f1f5f9; font-weight: 600; }
.loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 99998; }
`;
        document.head.appendChild(style);
    };

    // â”€â”€â”€ Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚ â”€â”€â”€
    const createPanel = () => {
        const existing = document.getElementById('license-verify-panel');
        if (existing) existing.remove();
        const existingOverlay = document.getElementById('license-panel-overlay');
        if (existingOverlay) existingOverlay.remove();

        const overlay = document.createElement('div');
        overlay.id = 'license-panel-overlay';
        overlay.className = 'panel-overlay';

        const panel = document.createElement('div');
        panel.id = 'license-verify-panel';
        panel.className = 'license-verify-panel';
        panel.innerHTML = `
<div class="panel-header"><div class="panel-icon">ğŸ”</div><h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ</h2><p>Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ Ù„Ù„ØªØ­Ù‚Ù‚</p></div>
<form id="licenseVerifyForm"><div class="form-group"><label class="form-label">Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ</label><input type="text" id="licenseKeyInput" class="form-input" placeholder="XXXX-XXXX-XXXX-XXXX" autocomplete="off" required/></div><button type="submit" class="verify-btn" id="verifyBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ</button></form>
<div id="resultMessage" class="result-message"></div>
<div id="userInfo" class="user-info"></div>
<a href="https://t.me/DEVNILOY" target="_blank" class="telegram-btn"><i class="fab fa-telegram-plane"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</a>
`;

        document.body.appendChild(overlay);
        document.body.appendChild(panel);
        setTimeout(() => document.getElementById('licenseKeyInput').focus(), 100);
        document.getElementById('licenseVerifyForm').onsubmit = handleVerify;
        window.closeLicensePanel = closePanel;
    };

    const closePanel = (animated = true) => {
        const panel = document.getElementById('license-verify-panel');
        const overlay = document.getElementById('license-panel-overlay');
        if (panel) {
            if (animated) {
                panel.classList.add('hiding');
                setTimeout(() => { panel.classList.add('hidden'); if (overlay) overlay.remove(); }, 300);
            } else {
                panel.remove();
                if (overlay) overlay.remove();
            }
        }
    };

    // â”€â”€â”€ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² â”€â”€â”€
    const generateDeviceFingerprint = () => {
        try {
            let deviceId = localStorage.getItem(STORAGE_DEVICE_ID);
            if (deviceId) return deviceId;

            const fingerprint = [
                navigator.userAgent, navigator.language, 
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency || 'unknown',
                navigator.platform
            ].join('|');

            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }

            const randomComp = Math.random().toString(36).substring(2, 10);
            deviceId = 'DEV-' + Math.abs(hash).toString(36).toUpperCase() + '-' + randomComp.toUpperCase();
            deviceId = deviceId.substring(0, 12) + '-' + deviceId.substring(12);
            localStorage.setItem(STORAGE_DEVICE_ID, deviceId);
            return deviceId;
        } catch (e) {
            return 'DEV-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
        }
    };

    const getDeviceInfo = () => {
        const deviceId = generateDeviceFingerprint();
        return {
            deviceId, name: navigator.userAgent.includes('Mobile') ? 'Ø¬Ù‡Ø§Ø² Ù…Ø­Ù…ÙˆÙ„' : 'Ø¬Ù‡Ø§Ø² Ù…ÙƒØªØ¨ÙŠ',
            info: `${navigator.platform} | ${screen.width}x${screen.height}`,
            userAgent: navigator.userAgent.substring(0, 100), verifiedAt: Date.now()
        };
    };

    const normalizeLicenseKey = (key) => key ? key.replace(/[^A-Z0-9]/gi, '').toUpperCase() : '';
    const formatLicenseKey = (key) => {
        const normalized = normalizeLicenseKey(key);
        return normalized.length !== 16 ? normalized : normalized.replace(/(.{4})/g, '$1-').slice(0, -1);
    };

    // â”€â”€â”€ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ â”€â”€â”€
    const showResult = (message, type = 'info') => {
        const resultEl = document.getElementById('resultMessage');
        resultEl.textContent = message;
        resultEl.className = `result-message ${type} show`;
    };

    const showUserInfo = (userData) => {
        const userInfoEl = document.getElementById('userInfo');
        const statusText = userData.status === 'active' ? 'Ù†Ø´Ø· âœ“' : userData.status === 'blocked' ? 'Ù…Ø­Ø¸ÙˆØ± âœ•' : 'Ù…Ø­Ø°ÙˆÙ';
        const statusColor = userData.status === 'active' ? '#10b981' : userData.status === 'blocked' ? '#ef4444' : '#94a3b8';

        userInfoEl.innerHTML = `
<div class="user-info-item"><span class="user-info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span><span class="user-info-value">${userData.username || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
<div class="user-info-item"><span class="user-info-label">Ø§Ù„Ù‡Ø§ØªÙ:</span><span class="user-info-value">${userData.phoneNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
<div class="user-info-item"><span class="user-info-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="user-info-value" style="color: ${statusColor}">${statusText}</span></div>
<div class="user-info-item"><span class="user-info-label">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©:</span><span class="user-info-value">${userData.devices ? userData.devices.length : 0}</span></div>
`;
        userInfoEl.classList.add('show');
    };

    // â”€â”€â”€ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â”€â”€â”€
    const handleVerify = async (e) => {
        e.preventDefault();
        const input = document.getElementById('licenseKeyInput');
        const verifyBtn = document.getElementById('verifyBtn');
        const licenseKey = normalizeLicenseKey(input.value);

        if (!licenseKey) { showResult('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ', 'error'); return; }

        verifyBtn.disabled = true;
        document.getElementById('userInfo')?.classList.remove('show');
        showResult('', '');

        const verifyStartTime = Date.now();
        let secondsElapsed = 0;
        const updateLoadingText = () => {
            secondsElapsed = Math.floor((Date.now() - verifyStartTime) / 1000);
            verifyBtn.innerHTML = `<span class="loading-spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... ${secondsElapsed}s${secondsElapsed >= 2 ? ' (ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)' : ''}`;
        };
        const counterInterval = setInterval(updateLoadingText, 100);
        updateLoadingText();

        try {
            const { foundUser, userId } = await fastVerifyLicense(licenseKey);
            clearInterval(counterInterval);

            if (!foundUser) {
                showResult('âŒ Ù…ÙØªØ§Ø­ ØªØ±Ø®ÙŠØµ ØºÙŠØ± ØµØ§Ù„Ø­!', 'error');
                verifyBtn.disabled = false; verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
                return;
            }

            if (foundUser.status === 'blocked') {
                showResult('âŒ Ø§Ù„ØªØ±Ø®ÙŠØµ Ù…Ø­Ø¸ÙˆØ±!', 'error');
                showUserInfo(foundUser);
                verifyBtn.disabled = false; verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
                return;
            }

            if (foundUser.status === 'deleted') {
                showResult('âŒ Ø§Ù„ØªØ±Ø®ÙŠØµ Ù…Ø­Ø°ÙˆÙ!', 'error');
                showUserInfo(foundUser);
                verifyBtn.disabled = false; verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
                return;
            }

            // ÙƒØ´Ù ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²
            const verified = getVerifiedLicense();
            const currentDeviceId = generateDeviceFingerprint();
            
            if (verified && verified.licenseKey) {
                if (normalizeLicenseKey(verified.licenseKey) === normalizeLicenseKey(licenseKey) && 
                    verified.verifiedDeviceId && 
                    verified.verifiedDeviceId !== currentDeviceId) {
                    
                    console.warn('âš ï¸ ÙƒØ´Ù ØªØ¨Ø¯ÙŠÙ„ Ø¬Ù‡Ø§Ø² - Ø­Ø¸Ø±');
                    try {
                        if (!database) await initFirebase();
                        await database.ref(`project_x009/users/${userId}`).update({
                            status: 'blocked', blockedReason: 'Device switching detected',
                            blockedAt: Date.now(), updatedAt: Date.now()
                        });
                    } catch (error) { console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¸Ø±:', error); }
                    
                    clearVerifiedLicense();
                    showResult('âŒ ØªÙ… Ø­Ø¸Ø± Ø§Ù„ØªØ±Ø®ÙŠØµ! ØªØ¨Ø¯ÙŠÙ„ Ø¬Ù‡Ø§Ø² Ù…ÙƒØªØ´Ù.', 'error');
                    verifyBtn.disabled = false; verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
                    return;
                }
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
            const deviceLimit = foundUser.deviceLimit || null;
            const currentDeviceCount = (foundUser.devices || []).length;
            const existingDevice = (foundUser.devices || []).find(d => d && d.deviceId === currentDeviceId);
            
            if (!existingDevice && deviceLimit !== null && currentDeviceCount >= deviceLimit) {
                showResult(`âŒ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (${currentDeviceCount}/${deviceLimit})!`, 'error');
                verifyBtn.disabled = false; verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
                return;
            }

            // Ù†Ø¬Ø§Ø­
            showResult('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            input.value = foundUser.licenseKey || formatLicenseKey(licenseKey);
            saveVerifiedLicense(foundUser.licenseKey, foundUser, currentDeviceId);
            addDeviceToUser(userId, foundUser).catch(console.error);
            startLicenseMonitoring(foundUser.licenseKey).catch(console.error);
            setTimeout(() => closePanel(true), 500);

        } catch (error) {
            clearInterval(counterInterval);
            console.error('Ø®Ø·Ø£:', error);
            showResult(error.message?.includes('timeout') ? 'âŒ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!' : 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚', 'error');
        } finally {
            clearInterval(counterInterval);
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ';
            console.log(`âš¡ Ø§ÙƒØªÙ…Ù„ ÙÙŠ ${((Date.now() - verifyStartTime)/1000).toFixed(1)}s`);
        }
    };

    // â”€â”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ â”€â”€â”€
    const fastVerifyLicense = async (licenseKey) => {
        const normalizedKey = normalizeLicenseKey(licenseKey);
        try {
            if (!database) {
                const initialized = await initFirebase();
                if (!initialized) throw new Error('Firebase not initialized');
            }

            const usersRef = database.ref('project_x009/users');
            const snapshot = await Promise.race([
                usersRef.once('value'),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000))
            ]);
            
            const users = snapshot.val();
            if (!users) return { foundUser: null, userId: null };

            for (const [key, user] of Object.entries(users)) {
                if (user.licenseKey && normalizeLicenseKey(user.licenseKey) === normalizedKey) {
                    return { foundUser: user, userId: key };
                }
            }
            return { foundUser: null, userId: null };
        } catch (error) {
            console.error('Fast verify error:', error);
            throw error;
        }
    };

    // â”€â”€â”€ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† â”€â”€â”€
    const saveVerifiedLicense = (licenseKey, userData, deviceId) => {
        try {
            localStorage.setItem(STORAGE_KEY, licenseKey);
            localStorage.setItem(STORAGE_USER_KEY, JSON.stringify(userData));
            if (deviceId) localStorage.setItem(STORAGE_VERIFIED_DEVICE, deviceId);
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ±Ø®ÙŠØµ');
        } catch (e) { console.error('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸:', e); }
    };

    const getVerifiedLicense = () => {
        try {
            const licenseKey = localStorage.getItem(STORAGE_KEY);
            const userData = localStorage.getItem(STORAGE_USER_KEY);
            const verifiedDeviceId = localStorage.getItem(STORAGE_VERIFIED_DEVICE);
            if (licenseKey && userData) {
                return { licenseKey, userData: JSON.parse(userData), verifiedDeviceId };
            }
        } catch (e) { console.error('ÙØ´Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:', e); }
        return null;
    };

    const clearVerifiedLicense = () => {
        try {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(STORAGE_USER_KEY);
            localStorage.removeItem(STORAGE_VERIFIED_DEVICE);
            console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ');
        } catch (e) { console.error('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­:', e); }
    };

    // â”€â”€â”€ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© â”€â”€â”€
    const startLicenseMonitoring = async (licenseKey) => {
        try {
            if (!database) {
                const initialized = await initFirebase();
                if (!initialized) return;
            }

            if (licenseListener) { licenseListener(); licenseListener = null; }

            const normalizedKey = normalizeLicenseKey(licenseKey);
            const usersRef = database.ref('project_x009/users');
            
            licenseListener = usersRef.on('value', (snapshot) => {
                const users = snapshot.val();
                if (!users) {
                    clearVerifiedLicense();
                    if (licenseListener) { licenseListener(); licenseListener = null; }
                    return;
                }

                let foundUser = null;
                for (const [, user] of Object.entries(users)) {
                    if (user.licenseKey && normalizeLicenseKey(user.licenseKey) === normalizedKey) {
                        foundUser = user; break;
                    }
                }

                if (!foundUser || foundUser.status !== 'active') {
                    clearVerifiedLicense();
                    if (licenseListener) { licenseListener(); licenseListener = null; }
                    const reason = !foundUser ? 'Ù…Ø­Ø°ÙˆÙ' : foundUser.status === 'blocked' ? 'Ù…Ø­Ø¸ÙˆØ±' : 'ØºÙŠØ± ØµØ§Ù„Ø­';
                    console.log(`âš ï¸ Ø§Ù„ØªØ±Ø®ÙŠØµ ${reason} - Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙˆØµÙˆÙ„`);
                    showNotification('âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ±Ø®ÙŠØµÙƒ. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….');
                } else {
                    const cached = getVerifiedLicense();
                    if (!cached || cached.userData.status !== foundUser.status) {
                        saveVerifiedLicense(foundUser.licenseKey, foundUser, generateDeviceFingerprint());
                    }
                }
            });
            console.log('ğŸ” Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
        } catch (error) { console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:', error); }
    };

    // â”€â”€â”€ Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² â”€â”€â”€
    const addDeviceToUser = async (userId, userData) => {
        try {
            if (!database || !userId) return;
            const deviceInfo = getDeviceInfo();
            const userRef = database.ref(`project_x009/users/${userId}`);
            
            const snapshot = await Promise.race([
                userRef.once('value'),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
            ]);
            
            const currentData = snapshot.val();
            if (!currentData) return;

            let devices = currentData.devices || [];
            const deviceLimit = currentData.deviceLimit || null;
            const existingDeviceIndex = devices.findIndex(d => d && d.deviceId === deviceInfo.deviceId);
            
            if (existingDeviceIndex >= 0) {
                devices[existingDeviceIndex] = { ...devices[existingDeviceIndex], verifiedAt: Date.now(), lastVerified: Date.now() };
                console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù‡Ø§Ø²');
            } else {
                if (deviceLimit !== null && devices.length >= deviceLimit) {
                    console.warn('âš ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ - Ø­Ø¸Ø±');
                    await Promise.race([
                        userRef.update({ status: 'blocked', blockedReason: 'Device limit exceeded', blockedAt: Date.now(), updatedAt: Date.now() }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                    ]);
                    console.log('ğŸš« ØªÙ… Ø§Ù„Ø­Ø¸Ø±');
                    return;
                }
                devices.push({ ...deviceInfo, connectedAt: Date.now(), lastVerified: Date.now() });
                console.log(`â• Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ (${devices.length}${deviceLimit ? `/${deviceLimit}` : ''})`);
            }

            await Promise.race([
                userRef.update({ devices, updatedAt: Date.now() }),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
            ]);
            console.log('âœ… ØªÙ… ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø²');
        } catch (error) { console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹:', error); }
    };

    // â”€â”€â”€ Ø¥Ø´Ø¹Ø§Ø± â”€â”€â”€
    const showNotification = (message) => {
        const notification = document.createElement('div');
        notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4); z-index: 100000; font-family: 'Segoe UI', sans-serif; font-weight: 500; animation: slideIn 0.3s ease; max-width: 400px;`;
        notification.textContent = message;
        
        const style = document.createElement('style');
        style.textContent = `@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`;
        document.head.appendChild(style);
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    };

    // â”€â”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â”€â”€â”€
    const checkVerifiedLicense = async () => {
        const verified = getVerifiedLicense();
        if (!verified) return false;
        try {
            const { foundUser } = await fastVerifyLicense(verified.licenseKey);
            if (foundUser && foundUser.status === 'active') {
                console.log('âœ… ØªØ±Ø®ÙŠØµ Ù…ÙˆØ¬ÙˆØ¯ - Ù…Ù†Ø­ Ø§Ù„ÙˆØµÙˆÙ„');
                startLicenseMonitoring(verified.licenseKey);
                return true;
            } else {
                clearVerifiedLicense();
                return false;
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
            clearVerifiedLicense();
            return false;
        }
    };

    // â”€â”€â”€ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â”€â”€â”€
    const setupAutoFormat = () => {
        const input = document.getElementById('licenseKeyInput');
        if (!input) return;
        input.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            if (value.length > 16) value = value.slice(0, 16);
            e.target.value = formatLicenseKey(value);
        });
        input.addEventListener('paste', () => {
            setTimeout(() => {
                let value = input.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
                if (value.length > 16) value = value.slice(0, 16);
                input.value = formatLicenseKey(value);
            }, 10);
        });
    };

    // â”€â”€â”€ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© â”€â”€â”€
    const init = async () => {
        injectStyles();
        await loadFontAwesome();
        const isVerified = await checkVerifiedLicense();
        if (!isVerified) {
            createPanel();
            setTimeout(setupAutoFormat, 100);
        } else {
            console.log('âœ… ØªØ±Ø®ÙŠØµ Ù…ÙˆØ¬ÙˆØ¯ - Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù„ÙˆØ­Ø©');
            console.log('ğŸ’¡ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚: localStorage.clear()');
        }
    };

    window.clearLicenseVerification = () => {
        clearVerifiedLicense();
        if (licenseListener) { licenseListener(); licenseListener = null; }
        console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ­Ù‚Ù‚. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
    };

    init();
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚!');
    console.log('ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… window.clearLicenseVerification() Ù„Ù„Ù…Ø³Ø­');

})();
